/**
 * CVE Alias Manager
 *
 * This module handles establishing and querying CVE alias relationships in the database.
 * It creates bidirectional alias relations between CVEMetadata records using the CVEAlias
 * junction table.
 *
 * **IMPORTANT: Identifier Normalization**
 * All vulnerability identifiers (CVE IDs, GHSA IDs, etc.) are normalized to UPPERCASE
 * before being stored in or queried from the CVEAlias table. This ensures case-insensitive
 * matching and prevents duplicate entries with different casing.
 *
 * The normalization happens automatically in all functions - you can pass identifiers
 * in any case, and they will be normalized internally:
 * - 'cve-2024-1234' → 'CVE-2024-1234'
 * - 'ghsa-xxxx-yyyy-zzzz' → 'GHSA-XXXX-YYYY-ZZZZ'
 *
 * Usage:
 * ```typescript
 * import { establishCVEAliasRelations, getCVEAliases } from '@shared/cve-alias-manager'
 *
 * // Establish alias relations when processing CVE data (accepts any case)
 * await establishCVEAliasRelations(
 *     prisma,
 *     'CVE-2024-1234',  // Will be normalized to uppercase
 *     'osv',
 *     ['GHSA-xxxx-xxxx-xxxx', 'CVE-2023-5678'],  // All will be normalized to uppercase
 *     'osv',
 *     logger
 * )
 *
 * // Query all aliases for a CVE (accepts any case)
 * const aliases = await getCVEAliases(prisma, 'cve-2024-1234')  // Normalized internally
 * // Returns: ['GHSA-XXXX-XXXX-XXXX', 'CVE-2023-5678'] (all uppercase)
 * ```
 */

import type { PrismaClient } from '@prisma/client'

interface Logger {
    warn: (message: string, data?: any) => void
    debug: (message: string, data?: any) => void
    error: (message: string, data?: any) => void
    info: (message: string, data?: any) => void
}

/**
 * Establish bidirectional alias relationships between CVEs
 *
 * Creates alias relations in both directions:
 * - Primary CVE -> Alias CVEs
 * - Alias CVEs -> Primary CVE
 *
 * This ensures that querying from either direction returns the complete set of aliases.
 *
 * @param prisma - Prisma client instance
 * @param primaryCveId - The primary CVE ID (e.g., "CVE-2024-1234")
 * @param primarySource - Source of the primary CVE (e.g., "osv", "cve.org", "github")
 * @param aliasesCveIds - Array of CVE IDs that are aliases (e.g., ["GHSA-xxxx-xxxx-xxxx"])
 * @param discoveredFrom - Source that reported this alias relationship
 * @param logger - Logger instance for debugging
 *
 * @example
 * // When processing OSV data for CVE-2024-1234 that lists GHSA-xxxx-xxxx-xxxx as an alias
 * await establishCVEAliasRelations(
 *     prisma,
 *     'CVE-2024-1234',
 *     'osv',
 *     ['GHSA-xxxx-xxxx-xxxx'],
 *     'osv',
 *     logger
 * )
 */
export const establishCVEAliasRelations = async (
    prisma: PrismaClient,
    primaryCveId: string,
    primarySource: string,
    aliasesCveIds: string[],
    discoveredFrom: string,
    logger: Logger
): Promise<void> => {
    const now = Math.floor(Date.now() / 1000)

    // Normalize primary CVE ID to uppercase
    const normalizedPrimaryCveId = primaryCveId.toUpperCase().trim()

    // Remove duplicates, filter out empty strings, and normalize to uppercase
    const uniqueAliases = [...new Set(
        aliasesCveIds
            .filter(id => id && id.trim().length > 0)
            .map(id => id.toUpperCase().trim())
    )]

    if (uniqueAliases.length === 0) {
        logger.debug(`[CVE Alias] No valid aliases to establish for ${normalizedPrimaryCveId}`)
        return
    }

    logger.info(`[CVE Alias] Establishing ${uniqueAliases.length} alias relations for ${normalizedPrimaryCveId} (source: ${primarySource})`)

    for (const aliasCveId of uniqueAliases) {
        // Skip self-reference
        if (aliasCveId === normalizedPrimaryCveId) {
            logger.debug(`[CVE Alias] Skipping self-reference: ${normalizedPrimaryCveId}`)
            continue
        }

        // Find all sources for this alias CVE (normalized search)
        // We create relations for all known sources of the alias CVE
        const aliasSources = await prisma.cVEMetadata.findMany({
            where: { cveId: aliasCveId },
            select: { source: true }
        })

        if (aliasSources.length === 0) {
            logger.debug(`[CVE Alias] Alias ${aliasCveId} not found in CVEMetadata, skipping`)
            continue
        }

        for (const { source: aliasSource } of aliasSources) {
            try {
                // Create bidirectional alias: primary -> alias (using normalized IDs)
                await prisma.cVEAlias.upsert({
                    where: {
                        primaryCveId_primarySource_aliasCveId_aliasSource: {
                            primaryCveId: normalizedPrimaryCveId,
                            primarySource,
                            aliasCveId,
                            aliasSource
                        }
                    },
                    create: {
                        primaryCveId: normalizedPrimaryCveId,
                        primarySource,
                        aliasCveId,
                        aliasSource,
                        discoveredAt: now,
                        discoveredFrom
                    },
                    update: {
                        // Update discoveredFrom if relation already exists but from different source
                        discoveredFrom
                    }
                })

                // Create bidirectional alias: alias -> primary (using normalized IDs)
                await prisma.cVEAlias.upsert({
                    where: {
                        primaryCveId_primarySource_aliasCveId_aliasSource: {
                            primaryCveId: aliasCveId,
                            primarySource: aliasSource,
                            aliasCveId: normalizedPrimaryCveId,
                            aliasSource: primarySource
                        }
                    },
                    create: {
                        primaryCveId: aliasCveId,
                        primarySource: aliasSource,
                        aliasCveId: normalizedPrimaryCveId,
                        aliasSource: primarySource,
                        discoveredAt: now,
                        discoveredFrom
                    },
                    update: {
                        // Update discoveredFrom if relation already exists but from different source
                        discoveredFrom
                    }
                })

                logger.debug(`[CVE Alias] Established bidirectional alias: ${normalizedPrimaryCveId}:${primarySource} <-> ${aliasCveId}:${aliasSource}`)
            } catch (error) {
                logger.error(`[CVE Alias] Failed to establish alias relation: ${normalizedPrimaryCveId} <-> ${aliasCveId}`, { error })
            }
        }
    }

    logger.info(`[CVE Alias] Completed establishing alias relations for ${normalizedPrimaryCveId}`)
}

/**
 * Get all CVE IDs that are aliases of the given CVE
 *
 * Returns a unique list of CVE IDs across all sources that are aliases
 * of the specified CVE. The result is deduplicated by CVE ID.
 *
 * @param prisma - Prisma client instance
 * @param cveId - The CVE ID to query aliases for (will be normalized to uppercase)
 * @returns Array of unique CVE IDs that are aliases
 *
 * @example
 * const aliases = await getCVEAliases(prisma, 'CVE-2024-1234')
 * // Returns: ['GHSA-xxxx-xxxx-xxxx', 'CVE-2023-5678']
 */
export const getCVEAliases = async (
    prisma: PrismaClient,
    cveId: string
): Promise<string[]> => {
    // Normalize input to uppercase
    const normalizedCveId = cveId.toUpperCase().trim()

    const aliases = await prisma.cVEAlias.findMany({
        where: { primaryCveId: normalizedCveId },
        select: { aliasCveId: true },
        distinct: ['aliasCveId']
    })

    return [...new Set(aliases.map(a => a.aliasCveId))]
}

/**
 * Get all CVEs related to a given CVE (including the CVE itself)
 *
 * Returns the complete set of CVE IDs that form an alias group,
 * including the original CVE ID. All IDs are normalized to uppercase.
 *
 * @param prisma - Prisma client instance
 * @param cveId - The CVE ID to query (will be normalized to uppercase)
 * @returns Array of unique CVE IDs in the alias group (all uppercase)
 *
 * @example
 * const relatedCves = await getAllRelatedCVEs(prisma, 'CVE-2024-1234')
 * // Returns: ['CVE-2024-1234', 'GHSA-xxxx-xxxx-xxxx', 'CVE-2023-5678']
 */
export const getAllRelatedCVEs = async (
    prisma: PrismaClient,
    cveId: string
): Promise<string[]> => {
    // Normalize input to uppercase
    const normalizedCveId = cveId.toUpperCase().trim()

    const aliases = await getCVEAliases(prisma, normalizedCveId)
    return [...new Set([normalizedCveId, ...aliases])]
}

/**
 * Delete all alias relations for a CVE
 *
 * Removes all bidirectional alias relations where the CVE appears
 * either as primary or as an alias. Useful for cleanup or when
 * re-establishing alias relations from scratch.
 *
 * @param prisma - Prisma client instance
 * @param cveId - The CVE ID to delete relations for (will be normalized to uppercase)
 * @param source - Optional source filter
 * @param logger - Logger instance for debugging
 *
 * @example
 * await deleteCVEAliasRelations(prisma, 'CVE-2024-1234', 'osv', logger)
 */
export const deleteCVEAliasRelations = async (
    prisma: PrismaClient,
    cveId: string,
    source?: string,
    logger?: Logger
): Promise<void> => {
    // Normalize input to uppercase
    const normalizedCveId = cveId.toUpperCase().trim()

    const where = source
        ? {
              OR: [
                  { primaryCveId: normalizedCveId, primarySource: source },
                  { aliasCveId: normalizedCveId, aliasSource: source }
              ]
          }
        : {
              OR: [{ primaryCveId: normalizedCveId }, { aliasCveId: normalizedCveId }]
          }

    const deleted = await prisma.cVEAlias.deleteMany({ where })

    logger?.info(`[CVE Alias] Deleted ${deleted.count} alias relations for ${normalizedCveId}${source ? `:${source}` : ''}`)
}

/**
 * Count alias relations for a CVE
 *
 * Returns the total number of alias relations (both directions)
 * for the specified CVE.
 *
 * @param prisma - Prisma client instance
 * @param cveId - The CVE ID to count relations for (will be normalized to uppercase)
 * @returns Number of alias relations
 */
export const countCVEAliasRelations = async (
    prisma: PrismaClient,
    cveId: string
): Promise<number> => {
    // Normalize input to uppercase
    const normalizedCveId = cveId.toUpperCase().trim()

    const count = await prisma.cVEAlias.count({
        where: {
            OR: [{ primaryCveId: normalizedCveId }, { aliasCveId: normalizedCveId }]
        }
    })

    return count
}
