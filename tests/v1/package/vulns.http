###
# Package Vulnerabilities API Tests - /v1/{package}/vulns
# Tests for getting all vulnerabilities affecting a package
###

# Load shared configuration
< ../../test.config.http

###
# Test 1: Get all vulnerabilities for a package
GET {{baseUrl}}/{{apiVersion}}/express/vulns
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 2: Get vulnerabilities with pagination (limit)
GET {{baseUrl}}/{{apiVersion}}/express/vulns?limit=10
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 3: Get vulnerabilities with offset
GET {{baseUrl}}/{{apiVersion}}/express/vulns?limit=10&offset=20
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 4: Verify response structure
# @name getPackageVulns
GET {{baseUrl}}/{{apiVersion}}/lodash/vulns
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

> {%
  client.test("Package vulnerabilities response is valid", function() {
    client.assert(response.status === 200, "Response status is 200");
    client.assert(response.body.packageName !== undefined, "Package name exists");
    client.assert(response.body.timestamp !== undefined, "Timestamp exists");
    client.assert(response.body.totalCVEs !== undefined, "Total CVEs count exists");
    client.assert(response.body.total !== undefined, "Total versions count exists");
    client.assert(response.body.limit !== undefined, "Limit exists");
    client.assert(response.body.offset !== undefined, "Offset exists");
    client.assert(response.body.hasMore !== undefined, "HasMore flag exists");
    client.assert(response.body.versions !== undefined, "Versions array exists");
    client.assert(Array.isArray(response.body.versions), "Versions is an array");
    
    if (response.body.versions.length > 0) {
      const version = response.body.versions[0];
      client.assert(version.version !== undefined, "Version has version number");
      client.assert(version.ecosystem !== undefined, "Version has ecosystem");
      client.assert(version.sources !== undefined, "Version has sources");
      client.assert(version.cveIds !== undefined, "Version has CVE IDs");
      client.assert(Array.isArray(version.cveIds), "CVE IDs is an array");
    }
  });
%}

###
# Test 5: Python package vulnerabilities
GET {{baseUrl}}/{{apiVersion}}/django/vulns?limit=20
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 6: Case insensitive package name
GET {{baseUrl}}/{{apiVersion}}/LODASH/vulns
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 7: Package with no known vulnerabilities
GET {{baseUrl}}/{{apiVersion}}/some-secure-package-hopefully/vulns
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 8: Verify CVE IDs in response
# @name checkCVEIDs
GET {{baseUrl}}/{{apiVersion}}/express/vulns?limit=5
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

> {%
  client.test("CVE IDs are properly formatted", function() {
    const versions = response.body.versions;
    if (versions && versions.length > 0) {
      versions.forEach((version, index) => {
        if (version.cveIds && version.cveIds.length > 0) {
          version.cveIds.forEach(cveId => {
            const isCVE = cveId.startsWith('CVE-');
            const isGHSA = cveId.startsWith('GHSA-');
            const isOther = !isCVE && !isGHSA;
            client.log(`Version ${version.version}: ${cveId}`);
            client.assert(cveId.length > 0, `CVE ID is not empty for version ${version.version}`);
          });
        }
      });
    }
  });
%}

###
# Test 9: Missing authentication
GET {{baseUrl}}/{{apiVersion}}/express/vulns
Content-Type: {{contentType}}

> {%
  client.test("Missing auth returns 401", function() {
    client.assert(response.status === 401, "Response status is 401");
  });
%}

###
# Test 10: Production - Get package vulnerabilities
GET {{prodUrl}}/{{apiVersion}}/express/vulns?limit=50
Authorization: Bearer {{token}}
Content-Type: {{contentType}}
