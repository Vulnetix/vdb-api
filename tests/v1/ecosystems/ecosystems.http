###
# Ecosystems API Tests - /v1/ecosystems
# Tests for listing all ecosystems with package counts
###

# Load shared configuration
< ../../test.config.http

###
# Test 1: Get all ecosystems
GET {{baseUrl}}/{{apiVersion}}/ecosystems
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 2: Verify response structure
# @name getEcosystems
GET {{baseUrl}}/{{apiVersion}}/ecosystems
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

> {%
  client.test("Ecosystems response is valid", function() {
    client.assert(response.status === 200, "Response status is 200");
    client.assert(response.body.timestamp !== undefined, "Timestamp exists");
    client.assert(response.body.ecosystems !== undefined, "Ecosystems array exists");
    client.assert(Array.isArray(response.body.ecosystems), "Ecosystems is an array");
    
    if (response.body.ecosystems.length > 0) {
      const ecosystem = response.body.ecosystems[0];
      client.assert(ecosystem.name !== undefined, "Ecosystem has name");
      client.assert(ecosystem.count !== undefined, "Ecosystem has count");
      client.assert(typeof ecosystem.count === 'number', "Count is a number");
    }
  });
%}

###
# Test 3: Check for common ecosystems
# @name checkCommonEcosystems
GET {{baseUrl}}/{{apiVersion}}/ecosystems
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

> {%
  client.test("Common ecosystems are present", function() {
    const ecosystems = response.body.ecosystems;
    const ecosystemNames = ecosystems.map(e => e.name.toLowerCase());
    
    // Check for at least some common ecosystems
    const hasNpm = ecosystemNames.includes('npm');
    const hasPyPI = ecosystemNames.includes('pypi');
    const hasMaven = ecosystemNames.includes('maven');
    
    client.log(`Found ecosystems: ${ecosystemNames.join(', ')}`);
    client.assert(ecosystems.length > 0, "At least one ecosystem exists");
  });
%}

###
# Test 4: Missing authentication
GET {{baseUrl}}/{{apiVersion}}/ecosystems
Content-Type: {{contentType}}

> {%
  client.test("Missing auth returns 401", function() {
    client.assert(response.status === 401, "Response status is 401");
  });
%}

###
# Test 5: Production - Get ecosystems
GET {{prodUrl}}/{{apiVersion}}/ecosystems
Authorization: Bearer {{token}}
Content-Type: {{contentType}}
