###
# Vulnerability Data API Tests - /v1/vuln
# Tests for CVEListV5 format vulnerability records
###

# Load shared configuration
< ../../test.config.http

###
# Test 1: Get vulnerability data by CVE ID
GET {{baseUrl}}/{{apiVersion}}/vuln/CVE-2024-1234
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 2: Verify CVEListV5 format response
# @name getVulnData
GET {{baseUrl}}/{{apiVersion}}/vuln/CVE-2024-1234
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

> {%
  client.test("Vulnerability data response is valid CVEListV5 format", function() {
    client.assert(response.status === 200, "Response status is 200");
    client.assert(Array.isArray(response.body), "Response is an array");

    if (response.body.length > 0) {
      const record = response.body[0];
      client.assert(record.dataType === "CVE_RECORD", "Data type is CVE_RECORD");
      client.assert(record.dataVersion !== undefined, "Data version exists");
      client.assert(record.cveMetadata !== undefined, "CVE metadata exists");
      client.assert(record.cveMetadata.cveId !== undefined, "CVE ID exists");
      client.assert(record.containers !== undefined, "Containers exist");
      client.assert(record.containers.cna !== undefined, "CNA container exists");
    }
  });
%}

###
# Test 3: Get vulnerability by GHSA identifier
GET {{baseUrl}}/{{apiVersion}}/vuln/GHSA-xxxx-xxxx-xxxx
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 4: Get vulnerability by EUVD identifier
GET {{baseUrl}}/{{apiVersion}}/vuln/EUVD-2024-1234
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 5: Get vulnerability by PYSEC identifier (Python ecosystem)
GET {{baseUrl}}/{{apiVersion}}/vuln/PYSEC-2024-1234
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 6: Get vulnerability by RUSTSEC identifier (Rust ecosystem)
GET {{baseUrl}}/{{apiVersion}}/vuln/RUSTSEC-2024-1234
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 7: Get vulnerability by GO identifier (Go ecosystem)
GET {{baseUrl}}/{{apiVersion}}/vuln/GO-2024-1234
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 8: Get vulnerability by OSV identifier
GET {{baseUrl}}/{{apiVersion}}/vuln/OSV-2024-1234
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 9: Vulnerability not found
GET {{baseUrl}}/{{apiVersion}}/vuln/CVE-9999-99999
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

> {%
  client.test("Non-existent vulnerability returns 404", function() {
    client.assert(response.status === 404, "Response status is 404");
  });
%}

###
# Test 10: Missing identifier
GET {{baseUrl}}/{{apiVersion}}/vuln/
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

> {%
  client.test("Missing identifier returns 400", function() {
    client.assert(response.status === 400 || response.status === 404, "Response status is 400 or 404");
  });
%}

###
# Test 11: Get high-profile CVE (Log4Shell)
GET {{baseUrl}}/{{apiVersion}}/vuln/CVE-2021-44228
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 12: Production - Get vulnerability data
GET {{prodUrl}}/{{apiVersion}}/vuln/CVE-2024-1234
Authorization: Bearer {{token}}
Content-Type: {{contentType}}
