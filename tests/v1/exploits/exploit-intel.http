###
# Exploit Intelligence API Tests - /v1/exploits
# Tests for exploit data and sightings
###

# Load shared configuration
< ../../test.config.http

###
# Test 1: Get exploit intelligence by CVE ID
GET {{baseUrl}}/{{apiVersion}}/exploits/CVE-2024-1234
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 2: Verify exploit response structure
# @name getExploitData
GET {{baseUrl}}/{{apiVersion}}/exploits/CVE-2024-1234
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

> {%
  client.test("Exploit data response is valid", function() {
    client.assert(response.status === 200, "Response status is 200");
    client.assert(response.body.identifier !== undefined, "Identifier exists");
    client.assert(response.body.timestamp !== undefined, "Timestamp exists");
    client.assert(response.body.count !== undefined, "Count exists");
    client.assert(response.body.summary !== undefined, "Summary exists");
    client.assert(response.body.exploits !== undefined, "Exploits array exists");
    client.assert(Array.isArray(response.body.exploits), "Exploits is an array");

    // Verify summary breakdown
    const summary = response.body.summary;
    client.assert(summary.exploitDb !== undefined, "ExploitDB count exists");
    client.assert(summary.metasploit !== undefined, "Metasploit count exists");
    client.assert(summary.nuclei !== undefined, "Nuclei count exists");
    client.assert(summary.crowdSec !== undefined, "CrowdSec count exists");
  });
%}

###
# Test 3: Get exploits by normalized CVE ID (without CVE- prefix)
GET {{baseUrl}}/{{apiVersion}}/exploits/2024-1234
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 4: Get exploits by GHSA identifier
GET {{baseUrl}}/{{apiVersion}}/exploits/GHSA-xxxx-xxxx-xxxx
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

###
# Test 5: No exploits found
GET {{baseUrl}}/{{apiVersion}}/exploits/CVE-9999-99999
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

> {%
  client.test("No exploits returns 404 or empty array", function() {
    client.assert(
      response.status === 404 || (response.status === 200 && response.body.count === 0),
      "Response indicates no exploits found"
    );
  });
%}

###
# Test 6: Get exploits for high-profile CVE (Log4Shell)
GET {{baseUrl}}/{{apiVersion}}/exploits/CVE-2021-44228
Authorization: Bearer {{token}}
Content-Type: {{contentType}}

> {%
  client.test("Log4Shell has exploit data", function() {
    if (response.status === 200) {
      client.assert(response.body.count > 0, "Has exploit records");
      client.assert(response.body.exploits.length > 0, "Exploits array not empty");
    }
  });
%}

###
# Test 7: Missing authentication
GET {{baseUrl}}/{{apiVersion}}/exploits/CVE-2024-1234
Content-Type: {{contentType}}

> {%
  client.test("Missing auth returns 401", function() {
    client.assert(response.status === 401, "Response status is 401");
  });
%}

###
# Test 8: Production - Get exploit intelligence
GET {{prodUrl}}/{{apiVersion}}/exploits/CVE-2024-1234
Authorization: Bearer {{token}}
Content-Type: {{contentType}}
